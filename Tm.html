<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=1280", initial-scale=1.0" />
  <title>Tm calculator</title>
 <link rel="stylesheet" href="style.css">
 <link rel="stylesheet" href="style_footer.css">
 <link rel="stylesheet" href="chatbox.css">
 <link rel="stylesheet" href="drop_style.css">
 <link rel="stylesheet" href="style_lang.css">

<style>
  body { font-family: Arial, sans-serif;  padding: 20px; }
  input, select, button { margin: 5px 0; padding: 5px; font-size: 14px; width: 100%; }
  table { border-collapse: collapse; margin-top: 20px; width: 100%; text-align: left; }
  th, td { border: 1px solid #888; padding: 10px; }
  #advancedSettings { margin-top: 10px; }
</style>
</head>
<body>
 <div class="menu-wrapper">
    <div class="menu-bar">
    <div class="topbar-buttons">
      <a href="home.html" class="topbar-btn" data-translate="menu_home">Home</a>
      <a href="about.html" class="topbar-btn" data-translate="menu_about">About</a>
    </div>

    <div class="dropdown">
  <button onclick="location.href='tools_home.html'" class="dropbtn main-link" data-translate="menu_tools">Tools â–¾</button>
  <div class="dropdown-content scroll-menu"> 
        <a href="dna.html" data-translate="tool1">DNA Translator</a>
        <a href="rna.html" data-translate="tool2">RNA Translator</a>
        <a href="dna_to_rna.html" data-translate="tool3">DNA to RNA Converter</a>
        <a href="rna_to_dna.html" data-translate="tool4">RNA to DNA Converter</a>
        <a href="reverse_comp.html" data-translate="tool5">Reverse Complement</a>
        <a href="orf.html" data-translate="tool6">ORF Finder</a>
        <a href="rna_orf.html" data-translate="tool7">RNA ORF Finder</a>
        <a href="primer.html" data-translate="tool8">Primer Design</a>
        <a href="Phylogeny.html" data-translate="tool9">Phylogeny Tree Builder</a>
        <a href="restriction.html" data-translate="tool10">Restriction site Finder</a>
        <a href="sequence_search.html" data-translate="tool11">Sequence Search Tool</a>
        <a href="msa.html" data-translate="tool12">Multi-Sequence Alignment</a>
        <a href="restriction_digest.html" data-translate="tool13">Restriction Digest Simulator</a>
        <a href="punnet.html" data-translate="tool14">Punnet Square</a>
        <a href="protein_structure.html" data-translate="tool15">Protein Structure Predictor</a>
        <a href="codon_optimisation.html" data-translate="tool16">Codon Optimisation Tool</a>
      </div>
    </div>

    <div class="dropdown">
      <button onclick="location.href='calculators_home.html'" class="dropbtn" data-translate="menu_calculators">Calculators â–¾</button>
      <div class="dropdown-content">  
        <a href="shannon.html" data-translate="calculator1">Shannon diversity index</a>
        <a href="gc.html" data-translate="calculator2">GC% calculator</a>
        <a href="PI.html" data-translate="calculator3">Protein Molecular Weight & pI</a>
        <a href="Hardy-Weinberg.html" data-translate="calculator4">Hardy-Weinberg calculator</a>
        <a href="Tm.html" data-translate="calculator5">Tm calculator</a>
      </div>
    </div>
  </div>

    <div class="floating-theme-toggle">
    <span id="theme-label">ðŸŒž</span>
    <label class="switch">
      <input type="checkbox" id="themeToggle">
      <span class="slider round"></span>
    </label>
   <div>
   <div class="floating-lang-toggle">
  <div class="custom-lang-switcher" id="lang-switcher">
    <div class="selected-lang">EN â–¼</div>
    <div class="lang-options">
      <div data-lang="en">EN</div>
      <div data-lang="bg">BG</div>
      <div data-lang="it">IT</div>
    </div>
  </div>
</div>

</div>
</div>
<div class="container">

<h1>
    <img src="Logo.png" alt="Logo" class="logo" />
    <span class="half1" data-translate="Tm_text1">Oligonucleotide Tm & Annealing Calculator</span>
    <span class="half2">| Momchi's Genetics Toolsâ„¢</span>
    
  </h1>
 

<label data-translate="Tm_text2">Oligonucleotide sequence:</label>
<input type="text" id="oligoSeq" data-translate="Tm_text3" placeholder="Enter DNA sequence (5'->3')">

<div id="advancedSettings">
  <h4 data-translate="Tm_text4">Advanced Settings (optional)</h4>
  <label data-translate="Tm_text5">Monovalent cation [Na+] (mM, default 50):</label>
  <input type="number" id="NaConc" value="50">

  <label data-translate="Tm_text6">Divalent cation [Mg2+] (mM, default 0):</label>
  <input type="number" id="MgConc" value="0">

  <label data-translate="Tm_text7">Oligonucleotide concentration (ÂµM, default 0.25):</label>
  <input type="number" id="oligoConc" value="0.25" step="0.01">
</div>

<button id="calculateBtn" data-translate="Tm_text8">Calculate Tm & Annealing Temp</button>

<div id="results"></div>

<script>
// Nearest-neighbor thermodynamics (Santa Lucia 1998)
const NN = {
Â  'AA': {dh:-7.9, ds:-22.2}, 'TT': {dh:-7.9, ds:-22.2},
Â  'AT': {dh:-7.2, ds:-20.4}, 'TA': {dh:-7.2, ds:-21.3},
Â  'CA': {dh:-8.5, ds:-22.7}, 'TG': {dh:-8.5, ds:-22.7},
Â  'GT': {dh:-8.4, ds:-22.4}, 'AC': {dh:-8.4, ds:-22.4},
Â  'CT': {dh:-7.8, ds:-21.0}, 'AG': {dh:-7.8, ds:-21.0},
Â  'GA': {dh:-8.2, ds:-22.2}, 'TC': {dh:-8.2, ds:-22.2},
Â  'CG': {dh:-10.6, ds:-27.2}, 'GC': {dh:-9.8, ds:-24.4},
Â  'GG': {dh:-8.0, ds:-19.9}, 'CC': {dh:-8.0, ds:-19.9}
};

// Terminal corrections
const termCorrection = {A:2.3, T:2.3, G:0, C:0};

// Parse DNA sequence
function parseSequence(seq){
Â  return seq.toUpperCase().replace(/[^ATGC]/g,'');
}

// Reverse complement
function revComp(seq){
Â  const comp = {A:'T',T:'A',G:'C',C:'G'};
Â  return seq.split('').reverse().map(b=>comp[b] || '').join('');
}

// Check self-complementarity (for Tm calculation)
function isSelfComplementary(seq){
Â  return seq === revComp(seq);
}

// Nearest-neighbor Tm calculation with Owczarzy salt correction (simplified)
function calcTmNEB(seq, Na=50, Mg=0, conc=0.25){
Â  seq = parseSequence(seq);
Â  if(seq.length < 2) return {Tm:'N/A', Ta:'N/A'};

Â  const selfComp = isSelfComplementary(seq);
Â  const concM = conc*1e-6;
Â  const effectiveConc = selfComp ? concM/2 : concM;

Â  let dh = 0, ds = 0;
Â  for(let i=0;i<seq.length-1;i++){
Â  Â  const pair = seq[i]+seq[i+1];
Â  Â  if(NN[pair]){ dh += NN[pair].dh; ds += NN[pair].ds; }
Â  }

Â  // Terminal corrections
Â  dh += termCorrection[seq[0]]||0;
Â  dh += termCorrection[seq[seq.length-1]]||0;
Â  if(selfComp) ds -= 1.4; // symmetry correction

Â  const R = 1.987; // cal/(K*mol)
Â  let TmK = 1000*dh / (ds + R*Math.log(effectiveConc)); // Kelvin

Â  // Salt correction (Owczarzy 2008 simplified)
Â  const NaM = Na/1000; // mM -> M
Â  const MgM = Mg/1000;Â 
Â  const NaEq = NaM + 120*Math.sqrt(MgM); // Simplified equivalent Na
Â  TmK += 3.96 * Math.log(NaEq);

Â  const TmC = TmK-273.15;
Â  const Ta = TmC-5; // annealing temp approximation

Â  return {Tm:TmC.toFixed(2), Ta:Ta.toFixed(2)};
}

// --- NEW/FIXED SECONDARY STRUCTURE CHECKS ---

// Check for critical 3' end self-dimerization
function checkSelfDimer(seq) {
Â  Â  const minMatch = 3; // Minimum critical match length
Â  Â  if (seq.length < minMatch) return false;
Â  Â  
Â  Â  const rc = revComp(seq);
Â  Â  const threePrimeEnd = seq.slice(-minMatch);
Â  Â  
Â  Â  // Check if the 3' end ('CCC' in GGGAACCC) pairs with any part of the reverse complement (the other primer)
Â  Â  // If the 3'-end of Primer A has high complementarity to any part of Primer B (Reverse Complement), it's a risk.
Â  Â  
Â  Â  for(let i = 0; i <= rc.length - minMatch; i++) {
Â  Â  Â  Â  let match = true;
Â  Â  Â  Â  for(let j = 0; j < minMatch; j++) {
Â  Â  Â  Â  Â  Â  // Check 3' end of 'seq' against position 'i' in 'rc'
Â  Â  Â  Â  Â  Â  if (threePrimeEnd[j] !== rc[i + j]) {
Â  Â  Â  Â  Â  Â  Â  Â  match = false;
Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  if (match) return true; // Found a critical 3'-end match
Â  Â  }
Â  Â  return false;
}

// Check for hairpin potential (corrected to catch short, stable stems like 3bp GGG/CCC)
function checkHairpinStructure(seq){
Â  Â  const comp = {'A':'T','T':'A','G':'C','C':'G'};
Â  Â  const minStem = 3; // Start checking from 3 base pairs
Â  Â  const minLoop = 2; // Stable hairpins usually require a loop of at least 2 bases
Â  Â  
Â  Â  for(let len = minStem; len <= Math.floor(seq.length / 2); len++){
Â  Â  Â  Â  for(let i = 0; i <= seq.length - (len * 2) - minLoop; i++){
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  let stemMatch = true;
Â  Â  Â  Â  Â  Â  const stem1Start = i;
Â  Â  Â  Â  Â  Â  const stem2Start = i + len + minLoop;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Ensure the second stem is within bounds
Â  Â  Â  Â  Â  Â  if (stem2Start + len > seq.length) continue;

Â  Â  Â  Â  Â  Â  // Check complementarity of the stem (5' part vs 3' part)
Â  Â  Â  Â  Â  Â  for(let j = 0; j < len; j++){
Â  Â  Â  Â  Â  Â  Â  Â  const base1 = seq[stem1Start + j];
Â  Â  Â  Â  Â  Â  Â  Â  const base2 = seq[stem2Start + len - 1 - j]; // Check in reverse order
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (base1 !== comp[base2]){
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stemMatch = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if(stemMatch) return true; // Found a hairpin
Â  Â  Â  Â  }
Â  Â  }
Â  Â  return false;
}

// --- END OF NEW/FIXED CHECKS ---

document.getElementById('calculateBtn').addEventListener('click', ()=>{
Â  const seq = parseSequence(document.getElementById('oligoSeq').value.trim());
Â  if(!seq) return alert("Enter an oligonucleotide sequence.");
Â  const Na = parseFloat(document.getElementById('NaConc').value) || 50;
Â  const Mg = parseFloat(document.getElementById('MgConc').value) || 0;
Â  const conc = parseFloat(document.getElementById('oligoConc').value) || 0.25;

Â  const res = calcTmNEB(seq, Na, Mg, conc);
Â  
Â  // Use the new comprehensive checks
Â  const hasHairpin = checkHairpinStructure(seq);
Â  const hasSelfDimer = checkSelfDimer(seq);
Â  const secondaryStructure = (hasHairpin || hasSelfDimer) 
Â  Â  ? "Yes (Hairpin and/or 3' Dimer)" 
Â  Â  : "No";

Â  document.getElementById('results').innerHTML = `
Â  Â  <h3 data-translate="Tm_text10">Results:</h3>
Â  Â  <table>
Â  Â  Â  <tr><th data-translate="Tm_text11">Parameter</th><th data-translate="Tm_text12">Value</th></tr>
Â  Â  Â  <tr><td data-translate="Tm_text13">Melting temperature (Tm)</td><td>${res.Tm} Â°C</td></tr>
Â  Â  Â  <tr><td data-translate="Tm_text14">Annealing temperature (Ta)</td><td>${res.Ta} Â°C</td></tr>
Â  Â  Â  <tr><td data-translate="Tm_text15">Potential hairpin/self-dimer</td><td>${secondaryStructure}</td></tr>
Â  Â  </table>
Â  `;
Â loadTranslations(localStorage.getItem("selectedLang") || "en");
});
</script>
<hr>
<p data-translate="Tm_text9">The Tm Calculator estimates the melting and annealing temperatures of a DNA oligonucleotide based on sequence, salt concentrations, and oligo concentration. It also flags potential hairpins or self-dimers to help design effective primers.</p>
</div>
</div>
  <div id="chatbox-button">ðŸ’¬</div>

<div id="chatbox">
  <div class="chatbox-header">
    <span data-translate="chatbox1">Contact Me</span>
    <button id="close-chat">âœ–</button>
  </div>
  <div class="chatbox-body">
    <input type="text" id="chat-name" data-translate="chatbox2" placeholder="Your Name" />
    <input type="email" id="chat-email" data-translate="chatbox3" placeholder="Your Email" />
    <textarea id="chat-message" data-translate="chatbox4" placeholder="Type your message..."></textarea>
    <button id="send-message" data-translate="chatbox5">Send</button>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <script src="chatbox.js"></script>

  <script src="theme-toggle.js"></script>
  <script src="translate.js"></script>
</div>
<footer class="site-footer">
  <div class="footer-content">
    <p>&copy; 2025|Momchi's Genetics Tools. All rights reserved.</p>
    <p>
      <a href="about.html" data-translate="menu_about">About</a> |
      <a href="privacy.html" data-translate="privacy_title">Privacy Policy</a>
    </p>
  </div>
</footer>

</body>
</html>
